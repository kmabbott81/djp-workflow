# Next Refinements Prompt for Claude Code

Paste this into Claude Code to run the next sprint of improvements.

```
You are working inside the repository:
C:\Users\kylem\openai-agents-workflows-2025.09.28-v1

Context:
The DJP pipeline upgrades (schemas, provenance, citation disqualification, determinism, negative-path tests, night-shift E2E) are complete and green. Weâ€™re now tightening ergonomics and observability.

Mission:
Implement the following 6 refinements. Work incrementally, run tests, and produce a new timestamped run log at the end (YYYY.MM.DD-HHMM-NEXT-REFINEMENTS-COMPLETE.md) summarizing changes.

================================================================
1) Schema enforcement in CI/CD (fail fast)
================================================================
- Add `scripts/validate_artifacts.py` to validate schemas and sample artifacts.
- Add pytest for validating policy JSON against `schemas/policy.json` and artifact JSON against `schemas/artifact.json`.
- Optionally add `make schema-check` or `scripts/schema_check.ps1` for Windows.

================================================================
2) Cost visibility in CLI
================================================================
- Enhance `src/run_workflow.py` to print per-provider token usage and costs at the end of a run.
- Suppress with `--quiet`.

================================================================
3) Guardrails as reusable library
================================================================
- Refactor into `src/guardrails.py` with functions:
  - `check_long_quote`
  - `check_safety_flags`
  - `run_publish_guardrails`
- Update `publish.py` to use it pre- and at-publish.
- Add `tests/test_guardrails.py`.

================================================================
4) Performance regression smoke test
================================================================
- Add `tests/test_perf_smoke.py` to run a tiny deterministic run and assert duration < 60s.

================================================================
5) Artifacts versioning + CLI presets
================================================================
- Add `"schema_version": "1.0"` and optional `preset_name` to artifacts.
- Create `presets/cli/production.json` and `presets/cli/debug.json` with sensible defaults.
- Add `--preset <name>` option to `run_workflow.py` to merge defaults.

================================================================
6) Replay helper
================================================================
- Create `scripts/replay.py` that takes an artifact JSON and prints (or runs with `--exec`) the exact CLI command to reproduce.

================================================================
Housekeeping
================================================================
- Update docs/OPERATIONS.md with schema-check, cost footer, presets, and replay instructions.
- Ensure tests and lint pass.
- Write a new log file summarizing changes and next TODOs.

================================================================
Acceptance commands
================================================================
pytest -q tests/test_policies.py
python scripts/validate_artifacts.py
python -m src.run_workflow --preset production --task "150-word VTOL brief with 3 sources." --trace_name prod-demo
pytest -q tests/test_guardrails.py
pytest -q tests/test_perf_smoke.py
python scripts/replay.py runs/<ANY_ARTIFACT>.json
pytest -q
```

Reply ONLY with the list of created/modified files and a concise summary of changes.
```
