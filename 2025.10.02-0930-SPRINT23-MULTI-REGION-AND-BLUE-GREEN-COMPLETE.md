# Sprint 23: Multi-Region Deploy (Active/Active) + Blue/Green Releases — COMPLETE

**Date:** 2025-10-02 09:30
**Status:** ✅ All deliverables complete (44 new tests passing)

## Summary

Implemented multi-region active/active deployment infrastructure with blue/green release capabilities. Added health/readiness endpoints, region-aware routing with tenant stickiness, traffic manager for canary deployments, observability dashboard, and Docker healthcheck integration.

## Files Added

**`src/ops/health_server.py`** (161 lines) - Health/readiness HTTP server
- `start_health_server(port) -> Thread` - Background HTTP server
- `GET /health` - Always returns 200 if process alive
- `GET /ready` - Validates config, feature flags, region setup, RBAC role
- `GET /__meta` - Returns build metadata (version, git SHA, region)
- Configurable via `HEALTH_PORT`, `FEATURE_MULTI_REGION`, `FEATURE_BLUE_GREEN`, `REQUIRED_ENVS`

**`src/deploy/regions.py`** (177 lines) - Multi-region configuration
- `active_regions() -> List[str]` - Parse REGIONS env var
- `get_primary_region() -> str` - Get PRIMARY_REGION with validation
- `get_failover_policy() -> str` - Returns 'ordered' or 'round_robin'
- `preferred_region(tenant_id) -> str` - Hash-based or primary routing
- `next_failover(current_region) -> str` - Determine next failover region
- `validate_region_config() -> dict` - Comprehensive config validation

**`src/deploy/traffic_manager.py`** (174 lines) - Blue/green deployment manager
- `TrafficManager` class with state machine (idle → green_provisioned → canary → green_live → rollback)
- `provision_green(image_tag)` - Provision green deployment slot
- `start_canary(weight)` - Start canary at specified weight (0-100%)
- `increase_weight(weight)` - Progressively increase canary traffic
- `promote_green()` - Promote green to live (100% traffic)
- `rollback_to_blue(reason)` - Rollback to blue with audit trail
- RBAC enforcement: Requires DEPLOY_RBAC_ROLE='Deployer' or 'Admin'
- Audit logging to `logs/deploy_audit.log` and stdout (JSON)

**`scripts/blue_green_release.py`** (191 lines) - Blue/green deployment CLI
- Full deployment orchestration with canary progression
- Smoke tests regions via `/ready` endpoint
- Automatic rollback on failures
- Usage: `python scripts/blue_green_release.py --image-blue app:v1.0 --image-green app:v2.0 --canary-seq 2,10,25,50,100 --region us-east --region us-west --abort-on-err`

**`dashboards/observability_tab.py`** (147 lines) - Region observability UI
- Per-region health tiles with readiness status
- Recent failover events from `logs/region_events.jsonl`
- Recent deployment events from `logs/deploy_audit.log`
- Placeholder metrics (error rate, P95 latency)

**`tests/test_health_endpoints.py`** (148 lines) - 8 health server tests
**`tests/test_region_routing.py`** (178 lines) - 18 region routing tests
**`tests/test_blue_green.py`** (250 lines) - 18 blue/green deployment tests

## Files Modified

**`dashboards/app.py`**
- Added health server startup on app boot (background thread)
- Display region info in banner when `FEATURE_MULTI_REGION=true`
- Shows: `Region: us-east (active: us-east, us-west, eu-west)`

**`Dockerfile`**
- Added `ENV HEALTH_PORT=8086`
- Exposed port 8086 for health checks
- Updated HEALTHCHECK to use `/ready` endpoint: `CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:${HEALTH_PORT:-8086}/ready')" || exit 1`

## Test Results

### Sprint 23 Tests
```bash
pytest tests/test_health_endpoints.py tests/test_region_routing.py tests/test_blue_green.py -q

44 passed, 47 warnings in 0.59s
```

**Breakdown:**
- ✅ 8 tests - Health/readiness endpoints (health always 200, ready validates config, meta returns build info)
- ✅ 18 tests - Region routing (active regions parsing, primary validation, hash-based stickiness, failover sequences)
- ✅ 18 tests - Blue/green manager (RBAC enforcement, state transitions, canary progression, rollback, audit logging)

### All Tests
Previous tests (Sprint 1-22): 169 passing
Sprint 23 tests: 44 passing
**Total: 213 passing**

## Environment Variables

### Multi-Region Configuration
```bash
# Feature flags
FEATURE_MULTI_REGION=false     # Enable multi-region features
FEATURE_BLUE_GREEN=false       # Enable blue/green deployments

# Health server
HEALTH_PORT=8086               # Health check port
READINESS_TIMEOUT_MS=400       # Readiness check timeout
REQUIRED_ENVS=                 # Comma-separated list of required env vars

# Region configuration
REGIONS=us-east,us-west        # Active regions (comma-separated)
PRIMARY_REGION=us-east         # Primary region (must be in REGIONS)
CURRENT_REGION=us-east         # Current instance region
FAILOVER_POLICY=ordered        # Failover policy ('ordered' or 'round_robin')
TENANT_STICKY=hash             # Tenant routing ('hash' for consistent hashing, else primary)

# Deployment RBAC
DEPLOY_RBAC_ROLE=Deployer      # Role for deployment ops ('Deployer' or 'Admin')

# Build metadata (optional)
BUILD_VERSION=1.0.0            # Build version
GIT_SHA=abc123                 # Git commit SHA
BUILD_DATE=2025-10-02          # Build date
```

## Usage Examples

### Health Checks
```bash
# Check if process is alive
curl http://localhost:8086/health
# {"status": "healthy", "checks": {"process": "up"}}

# Check if ready for traffic
curl http://localhost:8086/ready
# {"status": "ready", "checks": {...}}

# Get build metadata
curl http://localhost:8086/__meta
# {"version": "1.0.0", "git_sha": "abc123", "region": "us-east"}
```

### Blue/Green Deployment
```bash
# Dry run
python scripts/blue_green_release.py \
  --image-blue app:v1.0-blue \
  --image-green app:v2.0-green \
  --canary-seq 2,10,25,50,100 \
  --region localhost:8086 \
  --abort-on-err \
  --timeout-s 60 \
  --dry-run

# Real deployment
export DEPLOY_RBAC_ROLE=Deployer
python scripts/blue_green_release.py \
  --image-blue app:v1.0-blue \
  --image-green app:v2.0-green \
  --canary-seq 2,10,25,50,100 \
  --region us-east-lb.example.com \
  --region us-west-lb.example.com \
  --abort-on-err \
  --timeout-s 120
```

### Region Configuration
```python
from src.deploy.regions import active_regions, preferred_region, next_failover

# Get active regions
regions = active_regions()  # ['us-east', 'us-west', 'eu-west']

# Get preferred region for tenant (hash-based routing)
region = preferred_region("tenant123")  # 'us-west' (deterministic)

# Get next failover region
next_region = next_failover("us-east")  # 'us-west' (ordered policy)
```

## Architecture

### Active/Active Multi-Region
```
                      ┌─────────────┐
                      │   Global    │
                      │ Load Balancer│
                      └──────┬──────┘
                             │
            ┌────────────────┼────────────────┐
            │                │                │
       ┌────▼────┐      ┌────▼────┐     ┌────▼────┐
       │ US-East │      │ US-West │     │ EU-West │
       │ (Primary)│      │         │     │         │
       └────┬────┘      └────┬────┘     └────┬────┘
            │                │                │
         Blue/Green       Blue/Green      Blue/Green
         Deployments      Deployments     Deployments
```

**Tenant Routing:**
- **Hash-based (TENANT_STICKY=hash)**: `hash(tenant_id) % len(regions)` - Ensures tenant always routes to same region
- **Primary-first (default)**: All tenants route to PRIMARY_REGION unless failover triggered

### Blue/Green State Machine
```
IDLE → provision_green → GREEN_PROVISIONED
                             ↓
                      start_canary(2%)
                             ↓
                          CANARY
                             ↓
                      increase_weight(10%, 25%, 50%, 100%)
                             ↓
                      promote_green()
                             ↓
                        GREEN_LIVE

                   (rollback_to_blue at any time)
                             ↓
                  ROLLBACK_IN_PROGRESS → IDLE
```

### Canary Progression Example
```
Blue: v1.0 ────────────────────────┐
                                   │
Green: v2.0  2%  10%  25%  50%  100% ← Promote
             ─┬───┬────┬────┬────┬──
Smoke Test    ✓   ✓    ✓    ✓    ✓
Wait 60s      ■   ■    ■    ■
```

## Security & RBAC

### Deployment Permissions
- **Deployer Role**: Can provision, canary, promote, rollback
- **Admin Role**: Can provision, canary, promote, rollback
- **Other Roles**: Blocked with `PermissionError`

### Audit Trail
Every deployment operation logged to `logs/deploy_audit.log`:
```json
{
  "timestamp": "2025-10-02T09:30:00.000Z",
  "action": "provision_green",
  "state": "green_provisioned",
  "blue_image": null,
  "green_image": "app:v2.0-green",
  "canary_weight": 0,
  "user": "deployer1",
  "deploy_role": "Deployer",
  "image_tag": "app:v2.0-green"
}
```

### Tenant Isolation
- Region routing respects tenant_id
- Hash-based stickiness ensures tenant data locality
- Cross-tenant routing blocked by RBAC (via existing tenant isolation)

## Rollback Procedures

### Disable Features
```bash
# Disable multi-region features
export FEATURE_MULTI_REGION=false

# Disable blue/green deployments
export FEATURE_BLUE_GREEN=false
```

### Rollback Deployment
```bash
# Via CLI
python scripts/blue_green_release.py \
  --image-blue app:v1.0-blue \
  --image-green app:v1.0-blue \
  --canary-seq 100 \
  --region localhost:8086

# Or programmatically
from src.deploy.traffic_manager import TrafficManager
manager = TrafficManager()
manager.rollback_to_blue("Manual rollback requested")
```

### Remove Multi-Region Code
```bash
# Revert all Sprint 23 changes
git revert <sprint-23-commit-hash>

# Or cherry-pick revert specific files
git checkout HEAD~1 src/ops/health_server.py
git checkout HEAD~1 src/deploy/
git checkout HEAD~1 scripts/blue_green_release.py
git checkout HEAD~1 dashboards/observability_tab.py
git checkout HEAD~1 Dockerfile
```

**No database changes** - No migrations required, fully safe rollback.

## Integration with Existing Systems

### RBAC (Foundation Patch)
- ✅ Deployment operations check `DEPLOY_RBAC_ROLE` env var
- ✅ Raises `PermissionError` for unauthorized roles
- ✅ Audit logs include user and role information

### Audit Logging (Foundation Patch)
- ✅ All deployment state changes logged to `logs/deploy_audit.log`
- ✅ JSON format compatible with existing audit infrastructure
- ✅ Includes timestamp, action, state, images, weights, user, role

### Tenant Isolation (Foundation Patch)
- ✅ Region routing respects tenant_id
- ✅ Hash-based stickiness provides tenant data locality
- ✅ Failover preserves tenant routing

### Docker (Sprint 8)
- ✅ Health check integrated via `/ready` endpoint
- ✅ Kubernetes-compatible liveness/readiness probes
- ✅ Non-blocking startup with proper retries

### Observability Dashboard
- ✅ Region health tiles show per-region status
- ✅ Failover events displayed in UI
- ✅ Deployment audit log integrated

## Manual Acceptance Criteria

### Health Endpoints
1. ✅ Start app with `streamlit run dashboards/app.py`
2. ✅ Verify health server starts on port 8086
3. ✅ `curl http://localhost:8086/health` returns 200
4. ✅ `curl http://localhost:8086/ready` returns 200 with no required envs
5. ✅ Set `REQUIRED_ENVS=FOO` without setting `FOO`, verify `/ready` returns 503

### Multi-Region Routing
1. ✅ Set `FEATURE_MULTI_REGION=true`, `REGIONS=us-east,us-west`, `PRIMARY_REGION=us-east`
2. ✅ Set `TENANT_STICKY=hash`
3. ✅ Verify `preferred_region("tenant1")` always returns same region
4. ✅ Verify `preferred_region("tenant2")` may return different region
5. ✅ Verify `next_failover("us-east")` returns `"us-west"`

### Blue/Green Deployment
1. ✅ Set `DEPLOY_RBAC_ROLE=Deployer`
2. ✅ Run dry-run: `python scripts/blue_green_release.py --dry-run ...`
3. ✅ Verify validation passes
4. ✅ Create `TrafficManager()` instance
5. ✅ Provision green, start canary, increase weight, promote
6. ✅ Verify `logs/deploy_audit.log` contains all events

### Docker Health Check
1. ✅ Build image: `docker build -t djp-workflow:test .`
2. ✅ Run container: `docker run -p 8080:8080 -p 8086:8086 djp-workflow:test`
3. ✅ Verify health check passes: `docker ps` shows "healthy" status
4. ✅ Stop health server, verify health check fails

## Known Issues

### Deprecation Warnings
- `datetime.utcnow()` used in traffic_manager.py (line 59)
- **Fix:** Replace with `datetime.now(datetime.UTC)`
- **Impact:** None (just warnings)

### Pre-existing Test Failures
- 3 tests fail (unrelated to Sprint 23): test_citation_disqualification_logic, test_policy_parameter_parsing, test_minimal_workflow_performance_sync
- **Impact:** Does not affect Sprint 23 functionality

## Definition of Done

- ✅ Health/readiness endpoints implemented (`/health`, `/ready`, `/__meta`)
- ✅ Multi-region configuration with tenant sticky routing
- ✅ Blue/green traffic manager with state machine
- ✅ Blue/green CLI with canary progression and auto-rollback
- ✅ Observability dashboard with region tiles and deployment log
- ✅ Docker healthcheck updated to use `/ready` endpoint
- ✅ 44 new tests passing (health server: 8, region routing: 18, blue/green: 18)
- ✅ All environment variables documented
- ✅ RBAC enforcement for deployment operations
- ✅ Audit logging for all deployment events
- ✅ Rollback procedures documented
- ✅ No breaking changes to existing features
- ✅ Completion log created

**Sprint Status: COMPLETE ✅**

---

**Next Steps:**
- Push to GitHub to trigger CI with new tests
- Consider Sprint 24 enhancements (rate limiting, circuit breakers, chaos testing)
