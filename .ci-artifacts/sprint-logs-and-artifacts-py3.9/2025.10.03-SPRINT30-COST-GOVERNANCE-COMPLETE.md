# Sprint 30: Cost Governance & Budget Guardrails - COMPLETE

**Date**: 2025-10-03
**Branch**: `sprint/30-cost-governance`
**Status**: ‚úÖ Complete

## Overview

Sprint 30 implements production-grade cost governance and budget enforcement on top of Sprint 25's cost telemetry. The system provides per-tenant and global budgets with dual-threshold enforcement (soft/hard), statistical anomaly detection, governance event logging, and dashboard integration.

## Objectives Completed

- ‚úÖ Cost ledger for loading and aggregating cost events from Sprint 25
- ‚úÖ Budget system with env and YAML configuration
- ‚úÖ Dual-threshold enforcer (soft throttle at 80%, hard deny at 100%)
- ‚úÖ Statistical anomaly detector using 7-day rolling baseline
- ‚úÖ Alert system with governance event logging
- ‚úÖ CLI cost report tool (text and JSON output)
- ‚úÖ Dashboard panel for cost governance monitoring
- ‚úÖ Comprehensive test coverage (49 tests, all passing)
- ‚úÖ Complete documentation (COSTS.md, OPERATIONS.md, SECURITY.md updates)

## Files Added

### Core Implementation

```
src/cost/
‚îú‚îÄ‚îÄ __init__.py                   # Package initialization
‚îú‚îÄ‚îÄ ledger.py                     # Load and aggregate cost events (125 lines)
‚îú‚îÄ‚îÄ budgets.py                    # Budget configuration (115 lines)
‚îú‚îÄ‚îÄ enforcer.py                   # Budget enforcement (198 lines)
‚îú‚îÄ‚îÄ anomaly.py                    # Statistical anomaly detection (126 lines)
‚îî‚îÄ‚îÄ alerts.py                     # Alert emission (43 lines)
```

### Scripts

```
scripts/
‚îî‚îÄ‚îÄ cost_report.py                # CLI cost reporting tool (147 lines)
```

### Tests

```
tests/
‚îú‚îÄ‚îÄ test_cost_ledger.py           # Ledger tests (105 lines)
‚îú‚îÄ‚îÄ test_budgets.py               # Budget tests (161 lines)
‚îú‚îÄ‚îÄ test_enforcer.py              # Enforcer tests (229 lines)
‚îú‚îÄ‚îÄ test_anomaly.py               # Anomaly tests (262 lines)
‚îî‚îÄ‚îÄ test_cost_report_cli.py       # CLI tests (281 lines)
```

### Documentation

```
docs/
‚îú‚îÄ‚îÄ COSTS.md                      # New: Complete cost governance guide (13,371 bytes)
‚îú‚îÄ‚îÄ OPERATIONS.md                 # Updated: Budget breach runbook, DLQ replay
‚îî‚îÄ‚îÄ SECURITY.md                   # Updated: Governance event auditing, RBAC
```

## Files Modified

```
dashboards/observability_tab.py   # Added Cost Governance panel (_render_cost_governance)
```

## Technical Architecture

### Data Flow

```
Sprint 25 Cost Telemetry
       ‚Üì
logs/cost_events.jsonl (input)
       ‚Üì
src/cost/ledger.py (load & aggregate)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
enforcer.py   anomaly.py   budgets.py   alerts.py
‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
logs/governance_events.jsonl (output)
       ‚Üì
Dashboard & CLI Reports
```

### Key Components

1. **Ledger** (`src/cost/ledger.py`)
   - Load cost events from JSONL with time window filtering
   - Rollup by dimensions (tenant, model, day)
   - Window sums for 1-day and 30-day periods

2. **Budgets** (`src/cost/budgets.py`)
   - Global and per-tenant budget configuration
   - Environment variable defaults
   - YAML override support (`config/budgets.yaml`)
   - `is_over_budget()` and `is_over_global()` checks

3. **Enforcer** (`src/cost/enforcer.py`)
   - Soft threshold (0.8): Throttle with warning
   - Hard threshold (1.0): Deny with `BudgetExceededError`
   - `should_deny()` and `should_throttle()` functions
   - Governance event emission to `logs/governance_events.jsonl`

4. **Anomaly Detector** (`src/cost/anomaly.py`)
   - 7-day rolling baseline (mean + std_dev)
   - Sigma threshold detection (default: 3œÉ)
   - Minimum dollar and event thresholds
   - Deterministic and testable

5. **Alerts** (`src/cost/alerts.py`)
   - Console output with severity icons (‚ÑπÔ∏è, ‚ö†Ô∏è, üö®)
   - Governance event logging
   - Extensible for email/Teams integration

6. **CLI Report** (`scripts/cost_report.py`)
   - Text output: Global/tenant budgets, anomalies
   - JSON output: Programmatic consumption
   - Filters: --tenant, --days
   - Budget status indicators (‚úÖ/üö®)

7. **Dashboard Panel** (`dashboards/observability_tab.py`)
   - Global budget status (daily/monthly)
   - Top 10 tenants by spend
   - Cost anomalies table
   - Recent governance events

## Configuration

### Environment Variables

```bash
# Global budgets
GLOBAL_BUDGET_DAILY=25.0
GLOBAL_BUDGET_MONTHLY=500.0

# Per-tenant defaults
TENANT_BUDGET_DAILY_DEFAULT=5.0
TENANT_BUDGET_MONTHLY_DEFAULT=100.0

# Enforcement thresholds
BUDGET_SOFT_THRESHOLD=0.8
BUDGET_HARD_THRESHOLD=1.0

# Anomaly detection
ANOMALY_SIGMA=3.0
ANOMALY_MIN_DOLLARS=3.0
ANOMALY_MIN_EVENTS=10

# File paths
COST_EVENTS_PATH=logs/cost_events.jsonl
GOVERNANCE_EVENTS_PATH=logs/governance_events.jsonl
BUDGETS_PATH=config/budgets.yaml
```

### YAML Configuration (Optional)

```yaml
# config/budgets.yaml
global:
  daily: 100.0
  monthly: 2000.0

tenants:
  premium-tenant:
    daily: 20.0
    monthly: 400.0

  trial-tenant:
    daily: 1.0
    monthly: 10.0
```

## Test Results

All 49 tests passing:

```
tests/test_cost_ledger.py       6 passed
tests/test_budgets.py           12 passed
tests/test_enforcer.py          9 passed
tests/test_anomaly.py           12 passed
tests/test_cost_report_cli.py   10 passed

============================= 49 passed in 3.14s ==============================
```

## Usage Examples

### Check Budget Before Execution

```python
from src.cost.enforcer import should_deny, should_throttle, BudgetExceededError

# Check before workflow execution
deny, reason = should_deny(tenant="tenant-1")
if deny:
    raise BudgetExceededError(reason)

throttle, reason = should_throttle(tenant="tenant-1")
if throttle:
    logger.warning(reason)
```

### Detect Cost Anomalies

```python
from src.cost.anomaly import detect_anomalies

# Detect anomalies for all tenants
anomalies = detect_anomalies()

for anom in anomalies:
    print(f"Tenant {anom['tenant']} today: ${anom['today_spend']:.2f}")
    print(f"Threshold: ${anom['threshold']:.2f} ({anom['sigma']}œÉ)")
```

### Generate Cost Report

```bash
# Global report
python scripts/cost_report.py

# Tenant-specific report
python scripts/cost_report.py --tenant tenant-1 --days 7

# JSON output
python scripts/cost_report.py --json > report.json
```

### Monitor Dashboard

```bash
streamlit run dashboards/app.py
```

Navigate to **Observability** tab ‚Üí **Cost Governance & Budgets** section

## Integration Points

### OpenAI Adapter (Sprint 25)

Add budget check before API calls:

```python
async def call_openai_api(tenant: str, ...):
    deny, reason = should_deny(tenant)
    if deny:
        raise BudgetExceededError(reason)

    response = await openai.chat.completions.create(...)
    emit_cost_event(tenant, response.usage, ...)
```

### Worker (Sprint 28/29)

Add budget check in job execution:

```python
async def execute_job(job: Job):
    try:
        deny, reason = should_deny(job.tenant)
        if deny:
            await dlq_send(job, reason="budget_exceeded", details=reason)
            return

        await run_workflow(job)
    except BudgetExceededError as e:
        await dlq_send(job, reason="budget_exceeded", details=str(e))
```

## Governance Events

All enforcement decisions logged to `logs/governance_events.jsonl`:

### budget_throttle
```json
{
  "event": "budget_throttle",
  "tenant": "tenant-1",
  "reason": "daily_budget_approaching",
  "daily_spend": 8.5,
  "daily_budget": 10.0,
  "threshold": 0.8,
  "timestamp": "2025-10-03T12:00:00Z"
}
```

### budget_deny
```json
{
  "event": "budget_deny",
  "tenant": "tenant-1",
  "reason": "daily_budget_exceeded",
  "daily_spend": 15.0,
  "daily_budget": 10.0,
  "timestamp": "2025-10-03T12:00:00Z"
}
```

### cost_anomaly
```json
{
  "event": "cost_anomaly",
  "tenant": "tenant-1",
  "today_spend": 50.0,
  "baseline_mean": 5.0,
  "threshold": 11.0,
  "sigma": 3.0,
  "timestamp": "2025-10-03T12:00:00Z"
}
```

## Operational Runbooks

### Budget Breach Runbook

1. **Immediate**: Jobs denied and sent to DLQ
2. **Alert**: Check dashboard or governance events
3. **Investigate**: `python scripts/cost_report.py --tenant tenant-1`
4. **Resolve**: Increase budget in `config/budgets.yaml` or optimize workflows
5. **Recover**: `python scripts/dlq_replay.py --reason budget_exceeded --tenant tenant-1`

### Monthly Budget Reset

1. Review governance events from previous month
2. Adjust budgets based on usage trends
3. Replay any budget-denied DLQ jobs
4. Update `config/budgets.yaml` with new limits

## Security Considerations

### RBAC

| Resource | Viewer | Editor | Admin | Deployer |
|----------|--------|--------|-------|----------|
| View budgets | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| View governance events | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Modify budgets | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| Replay DLQ jobs | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |

### Audit Trail

All governance events provide:
- **Who**: Tenant ID
- **What**: Event type (throttle, deny, anomaly)
- **When**: ISO 8601 timestamp
- **Why**: Reason (daily_budget_exceeded, etc.)
- **Context**: Spend amounts, limits, thresholds

### Compliance

- Retention: 90+ days for governance events
- Access control: Budget config restricted to admins
- Change tracking: All budget modifications logged
- Alerting: Configured for repeated denials

## Dependencies

- Sprint 25: Cost telemetry (`logs/cost_events.jsonl`)
- Sprint 28/29: Worker & DLQ (for job rejection)
- Python 3.13+
- Libraries: `pyyaml` (for YAML config)

## Future Enhancements

Potential Sprint 31+ improvements:

1. Email/Teams alert integration
2. Predictive budgets (forecast month-end spend)
3. Cost attribution by workflow type
4. Budget rollover between periods
5. Automatic rate limiting when approaching budgets
6. AI-powered cost optimization suggestions

## Validation Checklist

- ‚úÖ All 49 tests pass
- ‚úÖ Ledger loads and aggregates cost events correctly
- ‚úÖ Budgets load from env and YAML
- ‚úÖ Enforcer correctly identifies soft/hard threshold breaches
- ‚úÖ Anomaly detector flags statistical outliers
- ‚úÖ CLI report generates text and JSON output
- ‚úÖ Dashboard panel displays budget status
- ‚úÖ Governance events logged to JSONL
- ‚úÖ Documentation complete (COSTS.md, OPERATIONS.md, SECURITY.md)

## Known Limitations

1. **Baseline Calculation**: Anomaly baseline includes current day (by design for simplicity)
2. **No Email Alerts**: Console + log only (extensible for Sprint 31+)
3. **Manual Budget Updates**: Requires YAML edit and reload (no UI)
4. **No Predictive Budgets**: Current spend only, no forecasting

## Next Steps

1. Merge `sprint/30-cost-governance` to `main`
2. Deploy to staging for integration testing
3. Monitor governance events in production
4. Gather feedback for Sprint 31 enhancements
5. Consider integration with external alert systems

## References

- Sprint 25: Cost Telemetry (logs/cost_events.jsonl)
- Sprint 28/29: Worker & DLQ (job rejection)
- [COSTS.md](docs/COSTS.md): Complete cost governance guide
- [OPERATIONS.md](docs/OPERATIONS.md): Budget breach runbooks
- [SECURITY.md](docs/SECURITY.md): Governance event auditing, RBAC

---

**Sprint 30 Status**: ‚úÖ **COMPLETE**

All objectives met, tests passing, documentation complete, ready for merge.
