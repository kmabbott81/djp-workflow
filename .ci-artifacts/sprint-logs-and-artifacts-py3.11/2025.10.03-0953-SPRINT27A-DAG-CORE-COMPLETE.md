# Sprint 27A: DAG Core - COMPLETE

**Date**: 2025-10-03 09:53
**Status**: ✅ All tests passing (11/11)

## Files Added

1. **src/orchestrator/__init__.py** - Package marker
2. **src/orchestrator/graph.py** - DAG model, validation, topological sort (145 lines)
3. **src/orchestrator/runner.py** - DAG execution engine with retries (170 lines)
4. **src/workflows/adapter.py** - Workflow registry and adapters (75 lines)
5. **configs/dags/weekly_ops_chain.min.yaml** - Example 3-task chain
6. **scripts/run_dag_min.py** - CLI for running DAGs (120 lines)
7. **docs/ORCHESTRATION.md** - Minimal documentation (118 lines)
8. **tests/test_orchestrator_graph.py** - Graph validation tests (8 tests)
9. **tests/test_orchestrator_runner.py** - Runner execution tests (3 tests)

## Summary

**Sprint 27A** delivers a minimal, modular DAG orchestration core for chaining workflows:

- **Graph Model**: Task and DAG dataclasses with dependency tracking
- **Validation**: Checks for cycles, duplicate IDs, invalid dependencies
- **Topological Sort**: Kahn's algorithm for execution ordering
- **Runner**: Executes tasks in order with retry support and event logging
- **Payload Passing**: Namespaced output merging (task_id__key) to avoid collisions
- **Workflow Adapter**: Maps workflow_ref strings to callable functions
- **Dry-Run Support**: Plan execution without side effects
- **Event Logging**: JSONL format to logs/orchestrator_events.jsonl
- **CLI**: Load and execute DAGs from YAML configs

## Test Results

```
11 tests passed (8 graph + 3 runner)
- test_valid_dag_validates
- test_cycle_detected
- test_namespaced_merge_avoids_clobber
- test_toposort_orders_correctly
- test_empty_dag_fails_validation
- test_invalid_dependency_fails_validation
- test_duplicate_task_ids_fails_validation
- test_dry_run_prints_plan_no_side_effects
- test_retry_path_first_fails_second_succeeds
- test_task_failure_raises_runner_error
- test_payload_passing_between_tasks
```

**Known Issue**: datetime.utcnow() deprecation warnings (non-blocking)

## Usage

```bash
# Dry-run
python scripts/run_dag_min.py --dag configs/dags/weekly_ops_chain.min.yaml --dry-run

# Execute
python scripts/run_dag_min.py --dag configs/dags/weekly_ops_chain.min.yaml

# Override tenant
python scripts/run_dag_min.py --dag configs/dags/weekly_ops_chain.min.yaml --tenant acme_corp
```

## Example DAG

```yaml
name: weekly_ops_chain
tasks:
  - id: sweep
    workflow_ref: inbox_drive_sweep
    retries: 1
    depends_on: []
  - id: weekly_report
    workflow_ref: weekly_report_pack
    retries: 1
    depends_on: [sweep]
  - id: meeting_brief
    workflow_ref: meeting_transcript_brief
    retries: 1
    depends_on: [weekly_report]
```

## Limitations (Sprint 27A Scope)

- ✅ DAG validation and execution
- ✅ Retries with exponential backoff
- ✅ Payload passing between tasks
- ✅ Event logging (JSONL)
- ✅ Dry-run support
- ⏸️ Scheduler (deferred to 27B)
- ⏸️ State persistence (deferred to 27B)
- ⏸️ Observability dashboard (deferred to 27C)

## Environment

- Python 3.11+
- Dependencies: pyyaml, pytest
- Reuses existing retry logic from src/queue/retry.py

## Next Steps (Optional)

- Sprint 27B: Cron scheduler + state persistence
- Sprint 27C: Observability dashboard integration
- Fix datetime.utcnow() deprecation warnings
