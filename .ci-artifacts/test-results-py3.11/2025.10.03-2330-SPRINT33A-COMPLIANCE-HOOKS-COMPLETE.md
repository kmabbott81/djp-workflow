# Sprint 33A: Compliance Hooks - COMPLETE

**Date**: 2025-10-03
**Branch**: `sprint/33A-compliance-hooks`
**Status**: ✅ All acceptance criteria met

## Summary

Implemented GDPR-style compliance hooks for tenant data lifecycle management with data export, deletion, legal holds, and retention enforcement. All operations are tenant-scoped, RBAC-enforced, and fully audited via JSONL logs.

## Deliverables

### 1. Legal Hold Store ✅
**File**: `src/compliance/holds.py`

- Append-only JSONL log at `LOGS_LEGAL_HOLDS_PATH`
- `apply_legal_hold()`: Apply hold with reason
- `release_legal_hold()`: Release hold (validates hold exists)
- `is_on_hold()`: Check if tenant has active hold
- `current_holds()`: List all active holds
- Last-wins semantics for hold state tracking

### 2. Compliance APIs ✅
**File**: `src/compliance/api.py`

**Export**: `export_tenant(tenant, out_dir)`
- Collects tenant data from all stores
- Creates deterministic bundle: `{tenant}-export-{yyyy-mm-dd}/`
- Artifacts by reference (not copies, for CI efficiency)
- Includes: orchestrator events, queue events, cost tracking, approvals, governance logs
- RBAC: Auditor, Compliance, or Admin

**Delete**: `delete_tenant(tenant, dry_run, respect_legal_hold)`
- Removes tenant data from all stores
- Dry-run mode reports what would be deleted
- Blocks deletion if active legal hold (unless overridden)
- Returns counts per store
- RBAC: Compliance or Admin

**Retention**: `enforce_retention(now)`
- Prunes old data based on retention windows
- Safe JSONL rewrite (temp file + atomic swap)
- Preserves malformed entries to avoid data loss
- Configurable windows per data type
- RBAC: Compliance or Admin

**RBAC enforcement**: Role hierarchy check for all operations

### 3. CLI Tool ✅
**File**: `scripts/compliance.py`

**Commands**:
- `export --tenant <id> --out <dir>`: Export tenant data
- `delete --tenant <id> [--dry-run]`: Delete tenant data
- `hold --tenant <id> --reason "<text>"`: Apply legal hold
- `release --tenant <id>`: Release legal hold
- `holds --list`: List active holds
- `retention`: Enforce retention policies

**Exit codes**:
- `0`: Success
- `2`: RBAC denied
- `3`: Legal hold prevents operation
- `1`: Other error

**Output**: JSON summaries for all commands

### 4. Documentation ✅

**New**:
- `docs/COMPLIANCE.md` (complete guide, 600+ lines):
  - Core concepts (export, delete, holds, retention)
  - RBAC role hierarchy
  - CLI reference with examples
  - Audit surfaces
  - Common workflows
  - Troubleshooting
  - Best practices

**Updated**:
- `docs/SECURITY.md`: Compliance roles section
- `docs/OPERATIONS.md`: Compliance runbooks (export, delete, holds, retention, checklists)

### 5. Tests ✅

**56 tests, all passing**:
- `tests/test_compliance_holds.py` (12 tests): Apply/release/list holds, JSONL integrity
- `tests/test_compliance_export.py` (10 tests): Bundle structure, tenant filtering, RBAC
- `tests/test_compliance_delete.py` (12 tests): Dry-run, legal hold blocking, RBAC, counts
- `tests/test_compliance_retention.py` (13 tests): Pruning windows, safe swap, malformed lines
- `tests/test_compliance_cli.py` (9 tests): CLI commands, exit codes, JSON output

**Test coverage**:
- Legal holds with idempotency
- Export bundle determinism
- Deletion with legal hold protection
- Retention with temp file safety
- RBAC enforcement across all operations
- CLI exit codes and error handling

## Key Technical Decisions

1. **JSONL append-only logs**: All audit trails use JSONL with last-wins semantics
2. **Role hierarchy**: Viewer (0) < Author (1) < Operator (2) < Auditor (3) < Compliance (4) < Admin (5)
3. **Artifact references**: Export uses path lists instead of copies for CI efficiency
4. **Safe retention**: Temp file + atomic swap prevents corruption
5. **Legal hold blocking**: Default behavior blocks deletion with active hold
6. **Dry-run mode**: Test deletion scope before executing
7. **Exit code convention**: 0=success, 2=RBAC, 3=legal hold, 1=error

## Environment Variables

```bash
# RBAC
COMPLIANCE_RBAC_ROLE=Compliance  # Required role for mutations
USER_RBAC_ROLE=Auditor           # Current user's role

# Paths
LOGS_LEGAL_HOLDS_PATH=logs/legal_holds.jsonl
EXPORT_ROOT=exports

# Retention (days)
RETAIN_ORCH_EVENTS_DAYS=90       # Orchestrator events
RETAIN_QUEUE_EVENTS_DAYS=60      # Queue activity
RETAIN_DLQ_DAYS=30               # Dead letter queue
RETAIN_CHECKPOINTS_DAYS=90       # Approvals/checkpoints
RETAIN_COST_EVENTS_DAYS=180      # Cost tracking (6 months)
RETAIN_GOV_EVENTS_DAYS=365       # Governance (1 year)
```

## Acceptance Criteria Status

✅ Legal holds: apply/release/list work; delete honors holds by default
✅ Export bundles tenant-scoped data deterministically; CI uses reference lists
✅ Delete removes tenant data across stores or reports in dry-run; RBAC enforced
✅ Retention helpers prune JSONL stores by date safely (temp + swap)
✅ CLI emits JSON summaries; correct exit codes (0, 2, 3, 1)
✅ Docs added/updated (COMPLIANCE, SECURITY, OPERATIONS)
✅ pytest -q passes; all 56 new tests green
✅ Sprint log created

## Test Results

### Sprint 33A Tests
```
tests/test_compliance_holds.py ............ [12/12]
tests/test_compliance_export.py .......... [10/10]
tests/test_compliance_delete.py ........... [12/12]
tests/test_compliance_retention.py ....... [13/13]
tests/test_compliance_cli.py ......... [9/9]

56/56 passed ✅
```

### Regression Tests
```
tests/test_authz.py ............ [12/12]
tests/test_budgets.py ........... [11/11]

23/23 passed ✅ (No regressions)
```

## Files Added/Modified

### Core Implementation
- `src/compliance/__init__.py` (NEW)
- `src/compliance/holds.py` (NEW)
- `src/compliance/api.py` (NEW)

### CLI
- `scripts/compliance.py` (NEW)

### Documentation
- `docs/COMPLIANCE.md` (NEW - 600+ lines)
- `docs/SECURITY.md` (MODIFIED: added compliance roles section)
- `docs/OPERATIONS.md` (MODIFIED: added compliance runbooks)

### Tests
- `tests/test_compliance_holds.py` (NEW)
- `tests/test_compliance_export.py` (NEW)
- `tests/test_compliance_delete.py` (NEW)
- `tests/test_compliance_retention.py` (NEW)
- `tests/test_compliance_cli.py` (NEW)

### Sprint Log
- `2025.10.03-2330-SPRINT33A-COMPLIANCE-HOOKS-COMPLETE.md` (NEW)

## Usage Examples

### Export Tenant Data
```bash
export USER_RBAC_ROLE=Auditor
python scripts/compliance.py export --tenant acme-corp --out ./exports
```

### Delete Tenant (with safety checks)
```bash
export USER_RBAC_ROLE=Compliance

# 1. Check for legal hold
python scripts/compliance.py holds --list | jq -r '.holds[] | select(.tenant == "acme-corp")'

# 2. Export first (backup)
python scripts/compliance.py export --tenant acme-corp --out ./exports

# 3. Dry-run
python scripts/compliance.py delete --tenant acme-corp --dry-run

# 4. Live deletion
python scripts/compliance.py delete --tenant acme-corp
```

### Apply/Release Legal Hold
```bash
export USER_RBAC_ROLE=Compliance

# Apply hold
python scripts/compliance.py hold \
  --tenant acme-corp \
  --reason "Litigation hold - Case #2025-1234"

# List holds
python scripts/compliance.py holds --list

# Release hold
python scripts/compliance.py release --tenant acme-corp
```

### Enforce Retention
```bash
export USER_RBAC_ROLE=Compliance
python scripts/compliance.py retention
```

## Integration Points

### Data Stores Covered
1. **Tiered storage artifacts** (`artifacts/hot|warm|cold/`)
2. **Orchestrator events** (`logs/orchestrator_events.jsonl`)
3. **Queue events** (`logs/queue_events.jsonl`)
4. **Cost tracking** (`logs/cost_events.jsonl`)
5. **Approval/checkpoint records** (`logs/approvals.jsonl`)
6. **Governance events** (`logs/governance_events.jsonl`)

### Audit Surfaces
1. **Legal holds**: `logs/legal_holds.jsonl`
2. **Compliance operations**: `logs/governance_events.jsonl`
3. **Export manifests**: `exports/{tenant}-export-{date}/manifest.json`

## Future Enhancements

- Scheduled retention enforcement (daily cron job - commented for future)
- Per-tenant retention policy overrides
- Encrypted export bundles
- Email notifications for hold apply/release
- Web UI for compliance operations
- Integration with external archival systems (S3, GCS, Azure Blob)

## Security Guarantees

1. **RBAC enforcement**: All operations check user role
2. **Legal hold protection**: Deletion blocked by default with active hold
3. **Audit trail**: Complete history of all compliance operations
4. **Tenant isolation**: Operations strictly scoped to tenant data
5. **Safe deletion**: Dry-run mode + export-first workflow
6. **Retention safety**: Temp file + atomic swap prevents corruption
7. **Role separation**: Auditor can export but not delete

## Compliance Alignment

- **GDPR**: Right to access (export) + right to erasure (delete)
- **SOC 2**: Audit logging, access control, data retention
- **ISO 27001**: Data lifecycle management, retention policies
- **HIPAA**: Audit trails, access controls, retention (7 years)

## Next Steps

1. Schedule daily retention enforcement (cron/Task Scheduler)
2. Configure retention policies per compliance requirements
3. Train operations team on compliance procedures
4. Set up monitoring alerts for legal holds and deletions
5. Document incident response procedures
6. Test disaster recovery with export/restore workflow

## Sign-off

Sprint 33A complete. All acceptance criteria met. Compliance hooks operational with full test coverage, comprehensive documentation, and complete audit trail.
