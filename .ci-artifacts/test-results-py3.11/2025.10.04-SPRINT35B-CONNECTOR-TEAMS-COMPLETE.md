# Sprint 35B: Microsoft Teams Connector

**Date:** 2025-10-04
**Status:** ✅ Complete
**Branch:** `sprint/35B-connector-teams`
**Builds On:** Sprint 34B (Connector SDK), 34C (Observability), 35A (Health UI)

---

## Mission

Ship Microsoft Teams production connector with DRY_RUN/LIVE modes, OAuth2 token store, retry/backoff, circuit breaker, metrics integration, and webhook ingestion.

---

## Deliverables

### 1. Teams Connector (`src/connectors/teams.py`)

**Full Connector implementation:**
- Resources: teams, channels, messages
- Methods: list_resources, get_resource, create_resource, update_resource, delete_resource
- DRY_RUN mode (default): Mock responses from `logs/connectors/teams_mock.jsonl`
- LIVE mode: Real Microsoft Graph API calls
- OAuth2 token loading via `oauth2.load_token()`
- Retry with exponential backoff for 429/5xx errors
- Circuit breaker integration
- Metrics recording for all operations
- RBAC: Reads (Operator+), Writes (Admin)

### 2. HTTP Client (`src/connectors/http_client.py`)

**Minimal HTTP helper:**
- Tries `requests` library first, falls back to `urllib.request`
- Returns normalized response: `{status_code, headers, body}`
- Supports GET, POST, PATCH, DELETE
- Timeout configuration
- JSON body handling

### 3. Webhooks Module (`src/connectors/webhooks.py`)

**Event ingestion:**
- `ingest_event(connector_type, payload)` - Normalize webhook events
- Teams-specific normalization: `_normalize_teams_event()`
- Extracts: event_type, resource_type, resource_id, timestamp, data
- Records metrics for ingestion operations

### 4. Tests

**`tests/test_teams_connector_dryrun.py` (100 lines, 6 tests):**
- Dry-run CRUD operations (list, get, create, update, delete)
- Metrics recording verification
- Offline by default (CI-safe)
- Live mode test marked `@pytest.mark.live`

**`tests/test_teams_webhooks.py` (93 lines, 3 tests):**
- Webhook ingestion using sample data
- Normalization validation
- Missing fields handling

**Sample Data:** `tests/data/teams/webhooks/message_created.json`

### 5. Documentation

**`docs/CONNECTORS_TEAMS.md` (NEW - 179 lines):**
- Setup: Azure app registration, OAuth2 tokens
- Environment variables (MS_CLIENT_ID, MS_TENANT_ID, MS_CLIENT_SECRET, etc.)
- DRY_RUN vs LIVE modes
- CLI usage examples
- Rate limits (Graph API: 10,000 req/10min per app)
- RBAC requirements
- Observability integration
- Troubleshooting common errors

---

## Technical Implementation

### DRY_RUN Mode (Default)

```python
# Reads from logs/connectors/teams_mock.jsonl
connector = TeamsConnector("teams", "tenant-1", "user-1")
teams = connector.list_resources("teams")  # Returns mock data
# No network calls, CI-safe
```

### LIVE Mode

```python
# export LIVE=true
# export MS_CLIENT_ID=...
# export MS_TENANT_ID=...

connector = TeamsConnector("teams", "tenant-1", "user-1")
teams = connector.list_resources("teams")  # Real Graph API call

# OAuth2 token loaded from logs/connectors/tokens.jsonl
# Retry with backoff on 429/5xx
# Circuit breaker prevents cascading failures
# Metrics recorded to logs/connectors/metrics.jsonl
```

### Webhook Ingestion

```python
from src.connectors.webhooks import ingest_event

# Teams sends webhook to your endpoint
payload = {...}  # Teams webhook JSON

# Normalize to standard format
event = ingest_event("teams", payload)
# Returns: {connector_type, event_type, resource_type, resource_id, timestamp, data}
```

---

## Environment Variables

| Variable | Default | Required | Description |
|----------|---------|----------|-------------|
| `LIVE` | `false` | No | Enable real API calls |
| `DRY_RUN` | `true` | No | Use mock responses |
| `MS_CLIENT_ID` | - | Yes (LIVE) | Azure app client ID |
| `MS_TENANT_ID` | - | Yes (LIVE) | Azure tenant ID |
| `MS_CLIENT_SECRET` | - | Yes (LIVE) | Azure app secret |
| `GRAPH_BASE_URL` | `https://graph.microsoft.com/v1.0` | No | Graph API base URL |
| `TEAMS_DEFAULT_TEAM_ID` | - | No | Default team for operations |
| `TEAMS_DEFAULT_CHANNEL_ID` | - | No | Default channel for messages |
| `CONNECTOR_RBAC_ROLE` | `Operator` | No | Minimum role for CLI |
| `USER_ROLE` | `Viewer` | No | Current user role |

---

## Architecture

### Observability Integration

```
Teams Operation
   ↓
circuit.allow() → Check if circuit open
   ↓
oauth2.load_token() → Get access token
   ↓
http_client.request() → Call Graph API
   ↓
Retry on 429/5xx → compute_backoff_ms()
   ↓
circuit.record_success/failure()
   ↓
metrics.record_call() → Log to metrics.jsonl
   ↓
health_status() → Compute health (healthy/degraded/down)
   ↓
Dashboard + CLI display
```

---

## Acceptance Criteria

✅ Teams connector implements real resource paths
✅ Honors DRY_RUN/LIVE modes
✅ OAuth2 store used (token loading/refresh detection)
✅ Retry/backoff + circuit breaker enforced
✅ Metrics recorded for all operations
✅ Health reflects connector state
✅ Webhook stub ingests sample JSON payloads
✅ Docs added (Teams page)
✅ Tests pass (CI-safe, offline by default)
✅ Sprint log created

---

## Files Changed

### New Files (7)
- `src/connectors/http_client.py` - HTTP request helper (100 lines)
- `src/connectors/teams.py` - Teams connector implementation (430 lines)
- `src/connectors/webhooks.py` - Webhook ingestion module (65 lines)
- `tests/test_teams_connector_dryrun.py` - Dry-run tests (100 lines, 6 tests)
- `tests/test_teams_webhooks.py` - Webhook tests (93 lines, 3 tests)
- `tests/data/teams/webhooks/message_created.json` - Sample webhook data
- `docs/CONNECTORS_TEAMS.md` - Teams connector documentation (179 lines)
- `2025.10.04-SPRINT35B-CONNECTOR-TEAMS-COMPLETE.md` - Sprint log

### Modified Files (1)
- `src/connectors/teams_old.py` - Backed up original webhook-only implementation

**Total:** 8 new, 1 backed up, +967 lines

---

## Known Limitations

1. **OAuth2 Refresh Not Implemented** - Token refresh requires provider-specific flow (future sprint)
2. **Message Deletion Limited** - Graph API doesn't support full delete, uses soft delete
3. **No Pagination** - Resource listing returns first page only (add pagination in future sprint)
4. **Single Tenant** - MS_TENANT_ID is global, not per connector instance
5. **No CLI Integration** - `scripts/connectors.py` not updated (deferred to Sprint 35C)

---

## Next Steps

### Sprint 35C: Connector CLI Enhancement
- Update `scripts/connectors.py` with Teams-specific commands
- Add `--target teams` registration
- Add `test teams --action list|get|create|delete` commands
- Print breaker state + health summary

### Sprint 36: OAuth2 Refresh Flows
- Implement `refresh_token()` for Microsoft Graph
- Add token refresh automation
- Handle refresh failures gracefully

### Sprint 37: Additional Connectors
- Slack connector (similar pattern)
- Outlook connector (email/calendar)
- Generic webhook connector

---

## References

- Sprint 34B: Connector SDK v1
- Sprint 34C: Metrics, OAuth2, Retry, Circuit Breaker
- Sprint 35A: Health UI & Operations CLI
- Microsoft Graph API Docs: https://learn.microsoft.com/en-us/graph/api/overview
- Teams Webhooks: https://learn.microsoft.com/en-us/graph/webhooks
