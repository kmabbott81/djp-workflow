# Prometheus Alert Rules for Relay Actions API
# Generated from alerts.json for Prometheus compatibility
#
# To use:
# 1. Copy this file to your Prometheus rules directory
# 2. Update prometheus.yml:
#    rule_files:
#      - 'prometheus-alerts.yml'
# 3. Reload Prometheus: curl -X POST http://localhost:9090/-/reload

groups:
  - name: relay_api_golden_signals
    interval: 30s
    rules:
      - alert: LightEndpointLatencyHigh
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{path=~"/actions|/audit"}[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "Light endpoint p99 latency exceeds 50ms"
          description: "The p99 latency for light endpoints (list/preview/audit) is {{ $value }}s, which exceeds the 50ms SLO target. Check for slow database queries or increased load."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md#1-light-endpoints-listpreview---latency"

      - alert: WebhookExecuteLatencyHigh
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{path="/actions/execute"}[5m])) > 1.2
        for: 5m
        labels:
          severity: warning
          component: webhook
        annotations:
          summary: "Webhook execute p95 latency exceeds 1.2s"
          description: "The p95 latency for webhook executions is {{ $value }}s, which exceeds the 1.2s SLO target. Check webhook receiver latency or network issues."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md#2-webhook-execute---latency"

      - alert: ActionsErrorRateHigh
        expr: (sum(rate(http_requests_total{path=~"/actions.*", status=~"5.."}[5m])) / sum(rate(http_requests_total{path=~"/actions.*"}[5m]))) > 0.01
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Actions API error rate exceeds 1%"
          description: "The 5xx error rate for /actions endpoints is {{ $value | humanizePercentage }}, which exceeds the 1% SLO target. Check logs for exceptions and consider rollback if recent deploy."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md#3-error-rate"

      - alert: HighErrorStreak
        expr: (sum(rate(http_requests_total{status=~"5.."}[1m])) / sum(rate(http_requests_total[1m]))) > 0.10
        for: 3m
        labels:
          severity: page
          component: api
        annotations:
          summary: "Sustained high error rate - immediate action required"
          description: "The overall 5xx error rate is {{ $value | humanizePercentage }} (>10%) for 3+ minutes. This indicates a severe outage. Page on-call engineer immediately."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md#3-error-rate"

      - alert: RateLimitBreaches
        expr: rate(rate_limit_breaches_total[10m]) > 0
        for: 10m
        labels:
          severity: info
          component: rate-limiter
        annotations:
          summary: "Rate limit breaches detected"
          description: "Rate limit breaches are occurring at {{ $value }} per second. Review workspace usage and consider increasing limits if legitimate traffic."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/SPRINT-51-PHASE-2-STATUS.md#1-durable-rate-limiting-"

      - alert: ServiceDown
        expr: up{job="relay-backend"} == 0
        for: 1m
        labels:
          severity: page
          component: infrastructure
        annotations:
          summary: "Relay backend service is down"
          description: "The Relay backend service has been unreachable for 1+ minutes. Health checks are failing. Check Railway dashboard and logs immediately."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md#4-availability"

      - alert: DatabaseConnectionPoolExhausted
        expr: db_connection_pool_active / db_connection_pool_max > 0.9
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool near capacity"
          description: "Database connection pool is at {{ $value | humanizePercentage }} capacity. Consider increasing pool size or optimizing query patterns."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/SLOs.md"

      - alert: RedisDown
        expr: redis_up == 0
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis is unavailable"
          description: "Redis has been unavailable for 5+ minutes. Rate limiting will fall back to in-process mode, which may be less accurate in distributed deployments."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/SPRINT-51-PHASE-2-STATUS.md#1-durable-rate-limiting-"

  - name: gmail_slo
    interval: 30s
    rules:
      - alert: GmailErrorRateHigh
        expr: |
          (
            increase(action_error_total{provider="google",action="gmail.send"}[5m])
              /
            increase(action_exec_total{provider="google",action="gmail.send"}[5m])
          ) > 0.01
        for: 10m
        labels:
          severity: warning
          component: actions
          provider: google
        annotations:
          summary: "Gmail send error rate exceeds 1% (10m)"
          description: "The Gmail send error rate is {{ $value | humanizePercentage }}, which exceeds the 1% SLO target. Check OAuth tokens, Gmail API status, and recent error reasons."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/PHASE-C-OBSERVABILITY.md#issue-high-validation-error-rate"

      - alert: GmailLatencySlow
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(action_latency_seconds_bucket{provider="google",action="gmail.send"}[5m])) by (le)
          ) > 0.5
        for: 10m
        labels:
          severity: warning
          component: actions
          provider: google
        annotations:
          summary: "Gmail P95 latency exceeds 0.5s (10m)"
          description: "The P95 latency for Gmail send is {{ $value }}s, which exceeds the 500ms SLO target. Check Gmail API latency, network issues, or token refresh delays."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/observability/PHASE-C-OBSERVABILITY.md#issue-high-mime-build-latency"

      - alert: OAuthRefreshFailures
        expr: increase(oauth_events_total{provider="google",event="refresh_failed"}[15m]) > 5
        for: 0m
        labels:
          severity: warning
          component: oauth
          provider: google
        annotations:
          summary: "OAuth refresh failures spiking (>5 in 15m)"
          description: "OAuth token refresh for Google provider has failed {{ $value }} times in the last 15 minutes. Check refresh token validity, Google OAuth service status, and credential configuration."
          runbook_url: "https://github.com/kmabbott81/djp-workflow/blob/main/docs/evidence/sprint-53/oauth/REFRESH-LOGIC.md"
